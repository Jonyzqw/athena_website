---
sidebar_position: 4
sidebar_label: 四、业务镜像构建
---
# 业务镜像构建

## 环境依赖定义

环境依赖定义了推理插件所依赖的三方依赖库(requirements.txt)以及，python runtime运行环境，以及cuda相关版本定义 (todo@sea-wyq)

## 容器化

方式一:
* 如何编写Dockerfile并构建出镜像

创建Dockerfile文件：
```
FROM artifacts.iflytek.com/docker-private/atp/aiges-gpu:10.1-3.9.13-ubuntu1804-v1.0.0

WORKDIR /home/aiges

RUN  pip3 config set global.index-url https://pypi.mirrors.ustc.edu.cn/simple/ 

COPY requirements.txt /home/aiges/requirements.txt

RUN pip install -r /home/loader/requirements.txt

Copy 项目目录 /home/aiges

ENV PYTHONPATH=$PYTHONPATH:/home/aiges
ENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/home/wrapper/wrapper_lib

CMD ["sh", "-c", "./AIservice -m=0 -c=aiges.toml -s=svcName -u=http://companion.xfyun.iflytek:6868 -p=AIaaS -g=dx"]
```
通过docker构建镜像：
```
docker build -f Dockerfile -t ImageName:Tag .
```

方式二:
* 如何使用envd并构建镜像

创建build.envd文件

```
def build():
    mirror_config() 
    base(language="python3.8", os="ubuntu20.4")              #加载指定的base镜像
    install.python_packages(requirements="build.txt")        # 指定路径下进行requirments.txt安装
    install.conda_packages(env_file = "env.yaml")            # 指定路径下进行conda yaml环境安装
                   
    install.system_packages(name = [                         # 系统依赖安装
        "libgl1-mesa-glx"
    ])
def mirror_config():                                         #下载源配置
    config.pip_index(url = "https://pypi.tuna.tsinghua.edu.cn/simple")
    config.conda_channel(channel="""
    channels:
    - defaults
    show_channel_urls: true
    default_channels:
    - https://repo.anaconda.com/pkgs/main
    - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/
    - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/
    - https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/pytorch/
    - https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/menpo/
    - https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/bioconda/
    - https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/msys2/
    - https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge/
    custom_channels:
    conda-forge: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
    msys2: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
    bioconda: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
    menpo: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
    pytorch: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
    pytorch-lts: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
    simpleitk: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
    """)
```

通过envd构建镜像：
```
envd build -t ImageName:Tag -f build.envd
```