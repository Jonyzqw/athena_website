---
sidebar_position: 3
sidebar_label: 三、实现推理逻辑
---
# 实现推理逻辑

在项目创建的wrapper.py中，用户只需要完成下面的任务即可完成推理服务的在athenaServing上适配和部署。

- 填写模型服务的输入输出
- 编写模型的推理服务流程（目前仅支持非流式）

注： `文中需要修改的key需要与创建能力的key值相同`。

### 填写推理项目所需依赖

```
########
# 请在此区域导入您的依赖库

# Todo
# for example: import numpy

########
```

### 根据模型要求修改模型超参数和网络输入参数
```
'''
定义请求类:
 params:  params 开头的属性代表最终HTTP协议中的功能参数parameters部分，
 input:   input字段多用与请求数据段，即body部分，当前支持 ImageBodyField, StringBodyField, 和AudioBodyField
'''


class UserRequest(object):
    params1 = StringParamField(key="mode", enums=["music", "humming"], value='humming')  # 定义枚举类超参数
    params2 = StringParamField(key="model", maxLength=44, required=True)                 # 定义字符串类超参数

    input1 = ImageBodyField(key="data", path="test_data/test.png")      # 定义测试用的图片数据
    input2 = StringBodyField(key="switch", value="ctrl")                # 定义测试用的文本信息
    input3 = AudioBodyField(key="data", path="/home/wrapper/test.wav")  # 定义测试用的音频数据

```

### 根据模型要求修改模型输出参数
```
'''
定义响应类:
 accepts:  accepts代表响应中包含哪些字段, 以及数据类型
 input:    input字段多用与请求数据段，即body部分，当前支持 ImageBodyField, StringBodyField, 和AudioBodyField
'''


class UserResponse(object):
    accept1 = StringBodyField(key="ouput_text")      # 定义模型输出的key关键字


```
### 根据服务模型编写推理逻辑
```
'''
用户实现， 名称必须为Wrapper, 必须继承SDK中的 WrapperBase类
'''

class Wrapper(WrapperBase):
    serviceId = "****"
    version = "****"
    requestCls = UserRequest()
    responseCls = UserResponse()

    def wrapperInit(cls, config: {}) -> int:      # 编写模型初始化逻辑（加载模型和配置）
        log.info(config)
        log.info("Initializing ...")
        return 0


    def wrapperOnceExec(cls, params: {}, reqData: DataListCls) -> Response:
        # 从reqData和params参数中获取模型的输入数据的超参数
        for req in reqData.list:
            log.info("reqData key: %s , size is %d" % (req.key, len(req.data)))

        # 编写推理逻辑
        reslut =  inference()

        #通过 ResponseData()封装推理返回的结果
        res = Response()
        l = ResponseData()
        l.key = "output_text"
        l.type = 0
        l.status = 3
        l.data = reslut
        l.len = len(reslut)
        res.list = [l]
    return res

```